// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 테이블 정의 및 관계(Relation) 설정 ---

model RefEquipment {
  eqpid String @id
  sdwt  String
  
  // [관계 설정] RefSdwt (N:1)
  sdwtRel     RefSdwt      @relation(fields: [sdwt], references: [sdwt]) 
  
  // [관계 설정] 다른 테이블들 (1:1 또는 1:N)
  agentInfo   AgentInfo?
  agentStatus AgentStatus?
  plgErrors   PlgError[]   
  eqpPerfs    EqpPerf[]    

  @@map("ref_equipment")
}

model RefSdwt {
  sdwt   String @id
  site   String
  isUse  String @map("is_use") // 'Y' or 'N'

  // [관계 설정] RefEquipment (1:N)
  equipments RefEquipment[]

  @@map("ref_sdwt")
}

model AgentInfo {
  eqpid       String  @id
  pcName      String? @map("pc_name")
  appVer      String? @map("app_ver")
  type        String?
  ipAddress   String? @map("ip_address")
  os          String?
  systemType  String? @map("system_type")
  locale      String?
  timezone    String?
  macAddress  String? @map("mac_address")
  
  // [관계 설정] RefEquipment (1:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_info")
}

model AgentStatus {
  eqpid          String    @id
  status         String?   // 'ONLINE' | 'OFFLINE'
  lastPerfUpdate DateTime? @map("last_perf_update")
  
  // [관계 설정] RefEquipment (1:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_status")
}

model PlgError {
  eqpid     String
  timeStamp DateTime @map("time_stamp")
  errorId   String?  @map("error_id")
  errorLabel String? @map("error_label")
  
  // [관계 설정] RefEquipment (N:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, timeStamp])
  @@map("plg_error")
}

// [수정] Wafer Data 테이블 상세 컬럼 추가 (WaferService 필터링용)
model PlgWfFlat {
  eqpid       String
  servTs      DateTime @map("serv_ts")
  
  // 조회 조건 컬럼
  lotid       String?
  waferid     Int?
  cassettercp String?
  stagercp    String?
  stagegroup  String?
  film        String?
  
  // 상세 데이터 컬럼
  point       Int?
  t1          Float?
  gof         Float?
  z           Float?
  srvisz      Float?
  x           Float?
  y           Float?
  dierow      Float?
  diecol      Float?

  // Primary Key 구성 (데이터 특성에 따라 조정 가능)
  @@id([eqpid, servTs]) 
  @@map("plg_wf_flat")
}

model EqpPerf {
  eqpid    String
  servTs   DateTime @map("serv_ts")
  ts       DateTime?
  cpuUsage Float?   @map("cpu_usage")
  memUsage Float?   @map("mem_usage")
  cpuTemp  Float?   @map("cpu_temp")
  gpuTemp  Float?   @map("gpu_temp")
  fanSpeed Float?   @map("fan_speed")

  // [관계 설정] RefEquipment (N:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, servTs])
  @@map("eqp_perf")
}

model EqpProcPerf {
  eqpid         String
  servTs        DateTime @map("serv_ts")
  processName   String   @map("process_name")
  memoryUsageMB Float?   @map("memory_usage_mb")

  @@id([eqpid, servTs, processName])
  @@map("eqp_proc_perf")
}

model EqpLampLife {
  eqpid        String
  lampId       String   @map("lamp_id")
  servTs       DateTime @map("serv_ts")
  ageHour      Int?     @map("age_hour")
  lifespanHour Int?     @map("lifespan_hour")
  lastChanged  DateTime? @map("last_changed")

  @@id([eqpid, lampId, servTs])
  @@map("eqp_lamp_life")
}

model ItmInfo {
  eqpid       String @id
  systemModel String? @map("system_model")
  serialNum   String? @map("serial_num")
  application String?
  version     String?
  dbVersion   String? @map("db_version")

  @@map("itm_info")
}

// CgfLotUniformityMetrics (필터링 제외 컬럼 정보 등)
model CgfLotUniformityMetrics {
  metricName String @id @map("metric_name")
  isExcluded String? @map("is_excluded") // 'Y' or 'N'

  @@map("cgf_lot_uniformity_metrics")
}
